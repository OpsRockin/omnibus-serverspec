---
general:
  artifacts:
    - "pkg"
machine:
  environment:
    GODIST: "go1.7.3.linux-amd64.tar.gz"
  post:
    - mkdir -p download
    - test -e download/$GODIST || curl -o download/$GODIST https://storage.googleapis.com/golang/$GODIST
    - sudo rm -rf /usr/local/go
    - sudo tar -C /usr/local -xzf download/$GODIST
  ruby:
    version: 2.3.3
  pre:
    - echo 'DOCKER_OPTS="-s btrfs -e lxc -D --userland-proxy=false"' | sudo tee -a /etc/default/docker
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.2-circleci'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker
dependencies:
  cache_directories:
    - "~/walter"
    - "~/.omnibus_cache"
  pre:
    - bash ./ci/install-walter-1.3.0.sh
    - go get github.com/jfrogdev/jfrog-cli-go/...
    - mkdir -p ~/.jfrog && echo '{"bintray":{}}' > ~/.jfrog/jfrog-cli.conf
    - bash -c 'mkdir -p ~/.omnibus_cache/{ubuntu14,centos6}'
    - docker pull opsrock/omnibus_base_ubuntu14
    - docker pull opsrock/omnibus_base_centos6
    - docker build -t builder-ubuntu1404 -f docker/Dockerfile.ubuntu1404 .
    - docker build -t builder-centos6 -f docker/Dockerfile.centos6 .
    - ~/bin/walter -c ci/walter_build.yml
test:
  override:
    - docker run -v $HOME/$CIRCLE_PROJECT_REPONAME/pkg:/opt/pkg ubuntu:trusty find /opt/pkg/ -name "*deb" -exec dpkg -i {} \;
    - docker run -v $HOME/$CIRCLE_PROJECT_REPONAME/pkg:/opt/pkg centos:6 find /opt/pkg/ -name "*rpm" -exec rpm -ivh {} \;
    - docker run -v $HOME/$CIRCLE_PROJECT_REPONAME/pkg:/opt/pkg centos:7 find /opt/pkg/ -name "*rpm" -exec rpm -ivh {} \;
    - rake > pkg/versions.json
deployment:
  master:
    branch: master
    commands:
      - ~/bin/walter -c ci/walter_release.yml
  devrelease:
    branch: /build_.*/
    commands:
      - ~/bin/walter -c ci/walter_release.yml
