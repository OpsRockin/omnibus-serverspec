---
version: 2
jobs:
  build:
    machine:
      # https://circleci.com/docs/2.0/configuration-reference/#machine
      image: ubuntu-1604:201903-01
    working_directory: /home/circleci/omnibus-serverspec
    steps:
      - checkout
      - restore_cache:
          key: omnibus-{{ .Branch }}
          paths:
            - /home/circleci/omnibus-serverspec/.omnibus_cache
            - /home/circleci/walter
            - /home/circleci/.go_workspace
      - run:
          name: install walter
          command: ./ci/install-walter-1.3.0.sh
      - run:
          name: build images to test
          command: |
            bash -c 'mkdir -p ~/.omnibus_cache/{ubuntu16,centos8}'
            docker pull opsrock/omnibus_base_ubuntu16
            docker pull opsrock/omnibus_base_centos8
            docker build -t builder-ubuntu1604 -f docker/Dockerfile.ubuntu1604 .
            docker build -t builder-centos8 -f docker/Dockerfile.centos8 .
            ~/bin/walter -c ci/walter_build.yml
      - run:
          name: ruby-version
          command: |
            gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
            rvm get stable
            rvm use 2.5 --default
            echo ruby-2.5 > .ruby-version
      - run:
          name: export versions.json
          command: |
            gem update --system
            gem install bundler --no-document
            bundle config set without "development test ship omnibus"
            bundle install
            bundle exec rake > pkg/versions.json
      - store_artifacts:
           path: /home/circleci/omnibus-serverspec/pkg
           destination: pkg
      - run:
          name: prepare persist_to_workspace
          command: |
            mkdir -p /tmp/workspace
            cp -a pkg /tmp/workspace
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - pkg
      - save_cache:
          key: omnibus-{{ .Branch }}
          paths:
            - /home/circleci/omnibus-serverspec/.omnibus_cache
            - /home/circleci/walter
            - /home/circleci/.go_workspace
      - store_artifacts:
           path: /home/circleci/omnibus-serverspec/pkg
           destination: pkg
  test:
    machine:
      image: ubuntu-1604:201903-01
    working_directory: /home/circleci/omnibus-serverspec
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: install built pkgs
          command: |
            for x in bionic focal ; do
              docker run -v /tmp/workspace/pkg:/opt/pkg -v `pwd`/test/test_deb.sh:/tmp/test.sh ubuntu:${x} bash /tmp/test.sh
            done
            for x in {6..8} ; do
              docker run -v /tmp/workspace/pkg:/opt/pkg -v `pwd`/test/test_rpm.sh:/tmp/test.sh centos:${x} bash /tmp/test.sh
            done
  deployment:
    machine: true
    working_directory: /home/circleci/omnibus-serverspec
    steps:
      - checkout
      - restore_cache:
          key: omnibus-deployment-{{ .Branch }}
          paths:
            - /home/circleci/walter
            - /home/circleci/.go_workspace
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: install walter
          command: ./ci/install-walter-1.3.0.sh
      - run:
          name: install jfrog-cli
          command: curl -fL https://getcli.jfrog.io | sh -x
      - run:
          name: setup jfrog-cli
          command: |
            mkdir -p ~/bin
            mv ./jfrog ~/bin/
            mkdir -p ~/.jfrog && echo '{"bintray":{}}' > ~/.jfrog/jfrog-cli.conf
      - run:
          name: ruby-version
          command: |
            gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
            rvm get stable
            rvm use 2.5 --default
            echo ruby-2.5 > .ruby-version
      - run:
          name: install package_cloud
          command: |
            gem update --system
            gem install bundler --no-document
            bundle config set without "development test omnibus"
            bundle install
      - run:
          name: shipit
          command: |
            cp -av /tmp/workspace/pkg/* pkg/
            ~/bin/walter -c ci/walter_release.yml
      - save_cache:
          key: omnibus-deployment-{{ .Branch }}
          paths:
            - /home/circleci/walter
            - /home/circleci/.go_workspace

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - build
      - test:
          requires:
            - build
      - deployment:
          requires:
            - build
            - test
          filters:
            branches:
              only:
                - master
                - /build_.*/
